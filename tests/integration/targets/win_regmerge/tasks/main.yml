# test code for the win_regmerge module
# Copyright: (c) 2025, Red Hat, Inc.

# clear the area of the registry we are using for tests
- name: remove setting
  ansible.windows.win_regedit:
    key: 'HKLM:\SOFTWARE\Wow6432Node\Cow Corp'
    state: absent

# copy over some registry files to work with
- name: copy over some registry files to work with
  ansible.windows.win_copy: src={{item}} dest={{ remote_tmp_dir }}\\{{item}}
  with_items:
     - settings1.reg
     - settings2.reg
     - settings3.reg

# basic test of changed behaviour in check mode
# merge in REG_SZ
- name: test 1 merge in a setting
  win_regmerge:
     path: "{{ remote_tmp_dir }}\\settings1.reg"
  register: merge10_result
  check_mode: yes

- assert:
    that:
      - "merge10_result.changed == true"

# basic test of changed behaviour
# merge in REG_SZ
- name: test 1 merge in a setting
  win_regmerge:
     path: "{{ remote_tmp_dir }}\\settings1.reg"
  register: merge11_result

- assert:
    that:
      - "merge11_result.changed == true"

# re run the merge
- name: test 1 merge in the setting again
  win_regmerge:
     path: "{{ remote_tmp_dir }}\\settings1.reg"
  register: merge12_result

# without a compare to key, should always report changed
- assert:
    that:
      - "merge12_result.changed == true"

# prune reg key
- name: test 1 remove setting
  ansible.windows.win_regedit:
     key: 'HKLM:\SOFTWARE\Wow6432Node\Cow Corp'
     state: absent

# observe behaviour when compare_to param is set check mode

- name: test 2 merge in a setting check mode
  win_regmerge:
    path: "{{ remote_tmp_dir }}\\settings1.reg"
    compare_to: 'HKLM:\SOFTWARE\Wow6432Node\Cow Corp\Moosic\ILikeToMooveIt'
  register: merge20_result
  check_mode: yes

- assert:
    that:
      - "merge20_result.changed == true"

# observe behaviour when compare_to param is set

- name: test 2 merge in a setting
  win_regmerge:
    path: "{{ remote_tmp_dir }}\\settings1.reg"
    compare_to: 'HKLM:\SOFTWARE\Wow6432Node\Cow Corp\Moosic\ILikeToMooveIt'
  register: merge21_result

- assert:
    that:
      - "merge21_result.changed == true"

# re run the merge
- name: test 2 merge in the setting again but with compare_key
  win_regmerge:
    path: "{{ remote_tmp_dir }}\\settings1.reg"
    compare_to: 'HKLM:\SOFTWARE\Wow6432Node\Cow Corp\Moosic\ILikeToMooveIt'
  register: merge22_result

# with a compare to key, should now report not changed
- assert:
    that:
      - "merge22_result.changed == false"

# prune the contents of the registry from the parent of the compare key downwards
- name: clean up remove setting
  ansible.windows.win_regedit:
    key: 'HKLM:\SOFTWARE\Wow6432Node\Cow Corp'
    state: absent

# merge in more complex settings check mode
- name: test 3 merge in a setting check mode
  win_regmerge:
    path: "{{ remote_tmp_dir }}\\settings3.reg"
    compare_to: 'HKLM:\SOFTWARE\Wow6432Node\Cow Corp\Moo Monitor'
  register: merge30_result
  check_mode: yes

- assert:
    that:
      - "merge30_result.changed == true"

# merge in more complex settings

- name: test 3 merge in a setting
  win_regmerge:
    path: "{{ remote_tmp_dir }}\\settings3.reg"
    compare_to: 'HKLM:\SOFTWARE\Wow6432Node\Cow Corp\Moo Monitor'
  register: merge31_result

- assert:
    that:
      - "merge31_result.changed == true"

# re run the merge
- name: test 3 merge in the setting again but with compare_key check
  win_regmerge:
    path: "{{ remote_tmp_dir }}\\settings3.reg"
    compare_to: 'HKLM:\SOFTWARE\Wow6432Node\Cow Corp\Moo Monitor'
  register: merge32_result

# with a compare to key, should now report not changed
- assert:
    that:
      - "merge32_result.changed == false"

# prune the contents of the registry from the compare key downwards
- name: clean up remove setting
  ansible.windows.win_regedit:
    key: 'HKLM:\SOFTWARE\Wow6432Node\Cow Corp'
    state: absent



# clean up registry files

- name: clean up registry files
  ansible.windows.win_file: path={{ remote_tmp_dir }}\\{{item}} state=absent
  with_items:
     - settings1.reg
     - settings2.reg
     - settings3.reg

# re-run all tests above using 'content' parameter instead of 'path' using similar reg files but without the BOM

# clear the area of the registry we are using for tests
- name: remove setting
  ansible.windows.win_regedit:
    key: 'HKLM:\SOFTWARE\Wow6432Node\Cow Corp'
    state: absent

# merge in REG_SZ check mode
- name: test 1 merge in a setting using 'content'
  win_regmerge:
    content: "{{ lookup('file', 'settings1c.reg') }}"
  register: merge10_result
  check_mode: yes

- assert:
    that:
      - "merge10_result.changed == true"

# merge in REG_SZ
- name: test 1 merge in a setting using 'content'
  win_regmerge:
    content: "{{ lookup('file', 'settings1c.reg') }}"
  register: merge11_result

- assert:
    that:
      - "merge11_result.changed == true"

# re run the merge
- name: test 1 merge in the setting again using 'content'
  win_regmerge:
    content: "{{ lookup('file', 'settings1c.reg') }}"
  register: merge12_result

# without a compare to key, should always report changed
- assert:
    that:
      - "merge12_result.changed == true"

# prune reg key
- name: remove setting
  ansible.windows.win_regedit:
     key: 'HKLM:\SOFTWARE\Wow6432Node\Cow Corp'
     state: absent

#observe behaviour when compare_to param is set check mode

- name: test 2 merge in a setting using 'content'
  win_regmerge:
    content: "{{ lookup('file', 'settings1c.reg') }}"
    compare_to: 'HKLM:\SOFTWARE\Wow6432Node\Cow Corp\Moosic\ILikeToMooveIt'
  register: merge20_result
  check_mode: yes

- assert:
    that:
      - "merge20_result.changed == true"

#observe behaviour when compare_to param is set

- name: test 2 merge in a setting using 'content'
  win_regmerge:
    content: "{{ lookup('file', 'settings1c.reg') }}"
    compare_to: 'HKLM:\SOFTWARE\Wow6432Node\Cow Corp\Moosic\ILikeToMooveIt'
  register: merge21_result

- assert:
    that:
      - "merge21_result.changed == true"

# re run the merge
- name: test 2 merge in the setting again but with compare_key using 'content'
  win_regmerge:
    content: "{{ lookup('file', 'settings1c.reg') }}"
    compare_to: 'HKLM:\SOFTWARE\Wow6432Node\Cow Corp\Moosic\ILikeToMooveIt'
  register: merge22_result

# with a compare to key, should now report not changed
- assert:
    that:
      - "merge22_result.changed == false"
# assert changed false

# prune the contents of the registry from the parent of the compare key downwards
- name: clean up remove setting
  ansible.windows.win_regedit:
    key: 'HKLM:\SOFTWARE\Wow6432Node\Cow Corp'
    state: absent

# merge in more complex settings check mode
- name: test 3 merge in a setting using 'content'
  win_regmerge:
    content: "{{ lookup('file', 'settings3c.reg') }}"
    compare_to: 'HKLM:\SOFTWARE\Wow6432Node\Cow Corp\Moo Monitor'
  register: merge30_result
  check_mode: yes

- assert:
    that:
      - "merge30_result.changed == true"

# merge in more complex settings
- name: test 3 merge in a setting using 'content'
  win_regmerge:
    content: "{{ lookup('file', 'settings3c.reg') }}"
    compare_to: 'HKLM:\SOFTWARE\Wow6432Node\Cow Corp\Moo Monitor'
  register: merge31_result

- assert:
    that:
      - "merge31_result.changed == true"


# re run the merge
- name: test 3 merge in the setting again but with compare_key check using 'content'
  win_regmerge:
    content: "{{ lookup('file', 'settings3c.reg') }}"
    compare_to: 'HKLM:\SOFTWARE\Wow6432Node\Cow Corp\Moo Monitor'
  register: merge32_result

# with a compare to key, should now report not changed
- assert:
    that:
      - "merge32_result.changed == false"


# prune the contents of the registry from the compare key downwards
- name: clean up remove setting
  ansible.windows.win_regedit:
    key: 'HKLM:\SOFTWARE\Wow6432Node\Cow Corp'
    state: absent

# END OF win_regmerge tests
